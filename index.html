<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Il Separatio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #181a24; color: #f7f7f7; margin:0; }
    h2 { color: #ffe066; margin-bottom: 10px; }
    #sidebar { background: #222; padding: 10px; min-width: 200px; float:left; border-radius:8px; margin-right:20px;}
    #chatArea { margin-left: 220px; padding: 10px; }
    #chatBox { background:#1b1e2c; border-radius:10px; height:300px; overflow:auto; margin-bottom:10px; padding:8px; }
    input, button { margin:5px; border-radius:6px; padding:6px; }
    button { background:#ffb703; color:#222; border:none; cursor:pointer; font-weight:bold; }
    button:active { background:#fb8500; }
    #adminPanel { background: #ffe06622; padding:10px; border-radius:10px; margin-top:18px;}
    #adminUsers button { margin-left:6px; }
    img, video { border-radius:6px; margin:2px; }
    @media (max-width: 900px) {
      #sidebar { float:none; margin-right:0; min-width:auto; }
      #chatArea { margin-left:0; }
    }
  </style>
</head>
<body>
  <div id="main" style="display:none;">
    <h2>Bine ai venit pe siteul <b>Il Separatio</b></h2>
    <div id="sidebar">
      <h3>Prieteni</h3>
      <div id="friendsList"></div>
      <h3>Cereri de prietenie</h3>
      <div id="requestsList"></div>
      <input id="addFriendInput" placeholder="Nume prieten" maxlength="10"/>
      <button id="addFriendBtn">Adaugă prieten</button>
      <div id="adminPanel" style="display:none;">
        <h3>👑 Panel Admin</h3>
        <div id="adminUsers"></div>
      </div>
    </div>
    <div id="chatArea">
      <div id="chatBox"></div>
      <input id="chatInput" maxlength="100" placeholder="Scrie un mesaj..." />
      <button id="sendBtn">Trimite</button>
      <input type="file" id="fileInput" multiple />
      <button id="callBtn">Sună</button>
    </div>
  </div>
  <div id="register">
    <h2>Bine ai venit pe siteul <b>Il Separatio</b></h2>
    <input type="text" id="username" maxlength="10" placeholder="Nume (max 10 caractere)" />
    <button onclick="register()">Crează cont</button>
    <div id="registerMsg"></div>
  </div>
  <div id="bannedMsg" style="display:none;"></div>

<script>
let users = JSON.parse(localStorage.getItem('users') || '{}');
let bans = JSON.parse(localStorage.getItem('bans') || '{}');
let chats = JSON.parse(localStorage.getItem('chats') || '{}');
let files = JSON.parse(localStorage.getItem('files') || '{}');
let username, room, mute = false, muteExpires = null;
let fileCount = {}, fileSize = {}, fileSent = {};

function saveAll() {
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('bans', JSON.stringify(bans));
  localStorage.setItem('chats', JSON.stringify(chats));
  localStorage.setItem('files', JSON.stringify(files));
}

function validName(name) {
  return /^[a-zA-Z0-9]{1,10}$/.test(name);
}

function register() {
  let value = document.getElementById('username').value;
  if (!validName(value)) {
    document.getElementById('registerMsg').innerText = 'Nume invalid!';
    return;
  }
  if (users[value]) {
    document.getElementById('registerMsg').innerText = 'Numele există deja!';
    return;
  }
  if (bans[value] && bans[value] > Date.now()) {
    document.getElementById('register').style.display = 'none';
    document.getElementById('bannedMsg').style.display = 'block';
    document.getElementById('bannedMsg').innerHTML = '<h2>😡 Imi pare rău, dar nu ești binevoit pentru comportamentul tău!</h2><div>Ai ban până la ' + new Date(bans[value]).toLocaleString() + '</div>';
    return;
  }
  users[value] = { username: value, friends: [], requests: [], muted: false, muteExpires: null, isAdmin: value === "lucabos22" };
  saveAll();
  username = value;
  document.getElementById('register').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  if (username === 'lucabos22') document.getElementById('adminPanel').style.display = 'block';
  setup();
}

function setup() {
  let user = users[username];
  mute = user.muted;
  muteExpires = user.muteExpires;
  room = username;
  renderFriends(user.friends);
  renderRequests(user.requests);
  joinRoom(username);
  renderMute();
  if (username === 'lucabos22') loadAdminPanel();
}

function renderFriends(friends) {
  let div = document.getElementById('friendsList');
  div.innerHTML = '';
  friends.forEach(f => {
    let d = document.createElement('div');
    d.innerHTML = f + ' <button onclick="startChat(\''+f+'\')">💬</button>';
    div.appendChild(d);
  });
}

function renderRequests(requests) {
  let div = document.getElementById('requestsList');
  div.innerHTML = '';
  requests.forEach(r => {
    let d = document.createElement('div');
    d.innerHTML = r + ' <button onclick="acceptReq(\''+r+'\')">✅</button>';
    div.appendChild(d);
  });
}

function startChat(friend) {
  room = [username, friend].sort().join('_');
  joinRoom(room);
  document.getElementById('chatBox').innerHTML = '';
}

function acceptReq(from) {
  let user = users[username];
  if (!user.friends.includes(from)) user.friends.push(from);
  user.requests = user.requests.filter(r => r !== from);
  if (!users[from].friends.includes(username)) users[from].friends.push(username);
  saveAll();
  setup();
}

document.getElementById('addFriendBtn').onclick = () => {
  let to = document.getElementById('addFriendInput').value;
  if (!validName(to)) return;
  if (!users[to]) return;
  if (!users[to].requests.includes(username) && username !== to) users[to].requests.push(username);
  saveAll();
  setup();
  document.getElementById('addFriendInput').value = '';
};

document.getElementById('sendBtn').onclick = () => {
  let txt = document.getElementById('chatInput').value;
  if (!txt || mute) return;
  addMsg(room, username, txt);
  document.getElementById('chatInput').value = '';
  renderChat(room);
};

function addMsg(room, from, text) {
  if (!chats[room]) chats[room] = [];
  chats[room].push({ from, text, ts: Date.now() });
  saveAll();
}

function joinRoom(room) {
  if (!chats[room]) chats[room] = [];
  cleanChat(room);
  renderChat(room);
}

function renderChat(room) {
  let box = document.getElementById('chatBox');
  box.innerHTML = '';
  (chats[room]||[]).forEach(m => {
    let div = document.createElement('div');
    div.innerHTML = '<b>' + m.from + ':</b> ' + m.text;
    box.appendChild(div);
  });
  (files[room]||[]).forEach(f => {
    let div = document.createElement('div');
    if(f.type.startsWith('image/')) {
      div.innerHTML = '<b>' + f.from + ':</b> <img src="' + f.file + '" height="80"/>';
    } else if(f.type.startsWith('video/')) {
      div.innerHTML = '<b>' + f.from + ':</b> <video src="' + f.file + '" controls height="80"></video>';
    } else {
      div.innerHTML = '<b>' + f.from + ':</b> <a href="' + f.file + '" download="file">📎 Descărcare</a>';
    }
    box.appendChild(div);
  });
}

document.getElementById('fileInput').onchange = function(e){
  let fs = e.target.files;
  let now = Date.now();
  fileCount[username] = fileCount[username] || [];
  fileSize[username] = fileSize[username] || 0;
  fileSent[username] = fileSent[username] || [];
  // Clean old files sent
  fileSent[username] = fileSent[username].filter(ts => now - ts < 60000);
  if (fileSent[username].length+fs.length > 5) return;
  let totalSize = fileSize[username];
  for(let i=0; i<fs.length; i++){
    if(fs[i].size > 20*1024*1024) continue;
    totalSize += fs[i].size;
  }
  if (totalSize > 100*1024*1024) return;
  for(let i=0; i<fs.length; i++){
    let f = fs[i];
    let reader = new FileReader();
    reader.onload = function(evt){
      if (!files[room]) files[room] = [];
      files[room].push({ from: username, file: evt.target.result, type: f.type, size: f.size, ts: now });
      fileSent[username].push(now);
      fileSize[username] += f.size;
      saveAll();
      renderChat(room);
    };
    reader.readAsDataURL(f);
  }
  e.target.value = '';
};

function cleanChat(room) {
  chats[room] = (chats[room]||[]).filter(m => m.ts > Date.now() - 10*60000);
  files[room] = (files[room]||[]).filter(f => f.ts > Date.now() - 60000);
  saveAll();
}

setInterval(() => {
  Object.keys(chats).forEach(cleanChat);
  renderChat(room);
}, 7000);

function renderMute() {
  if (mute) {
    document.getElementById('chatInput').disabled = true;
    document.getElementById('chatBox').innerHTML = '<div style="color:red;font-size:20px;">Nu poți vorbi până la: ' + new Date(muteExpires).toLocaleString() + '</div>';
  } else {
    document.getElementById('chatInput').disabled = false;
  }
}

document.getElementById('callBtn').onclick = function() {
  alert('Funcția de voice demo! Pentru voice real trebuie server backend!');
};

// Admin panel
function loadAdminPanel() {
  let div = document.getElementById('adminUsers');
  div.innerHTML = '';
  Object.values(users).forEach(u => {
    let userDiv = document.createElement('div');
    userDiv.innerHTML = '<span>' + u.username + '</span>' +
      '<button onclick="adminMute(\''+u.username+'\')">🔇 Mute</button>' +
      '<button onclick="adminUnmute(\''+u.username+'\')">🔈 Unmute</button>' +
      '<button onclick="adminBan(\''+u.username+'\')">🚫 Interzice</button>' +
      '<button onclick="adminUnban(\''+u.username+'\')">✅ Anulează</button>' +
      '<button onclick="adminSpy(\''+u.username+'\')">🕵️ Spionează</button>';
    div.appendChild(userDiv);
  });
}
function adminMute(user) {
  let time = prompt('Minute de mute?');
  if (!users[user]) return;
  users[user].muted = true;
  users[user].muteExpires = Date.now() + parseInt(time)*60000;
  saveAll();
  if(user === username) setup();
}
function adminUnmute(user) {
  if (!users[user]) return;
  users[user].muted = false;
  users[user].muteExpires = null;
  saveAll();
  if(user === username) setup();
}
function adminBan(user) {
  let time = prompt('Minute de ban?');
  bans[user] = Date.now() + parseInt(time)*60000;
  saveAll();
}
function adminUnban(user) {
  bans[user] = 0;
  saveAll();
}
function adminSpy(user) {
  alert('Admin poate „spiona” userul: ' + user + ' (demo) 👑');
}
</script>
</body>
</html>
